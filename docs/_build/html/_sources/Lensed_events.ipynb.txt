{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "817490f7-38eb-4c38-863b-6b9492f455d8",
   "metadata": {},
   "source": [
    "# Lensed event rates"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e874da0d-d04f-4958-bf23-1ea1670d151a",
   "metadata": {},
   "source": [
    "This document outlines the default settings for calculating detectable lensed gravitational wave event rates (per year) in [LeR](https://ler.readthedocs.io/en/latest/index.html).\n",
    "\n",
    "**Notes:**\n",
    "\n",
    "- For details on source properties and their distributions, please refer to the section titled \"Gravitational Wave Event Rates.\"\n",
    "- LeR's calculation of lensed rates is loosely based on the methodology described in [WIERDA et al. 2021](https://arxiv.org/pdf/2106.06303.pdf).\n",
    "\n",
    "**Parameters in Consideration:**\n",
    "\n",
    "* Source properties:\n",
    "    * $z_s$: Source redshift.\n",
    "    * $\\theta$: Gravitational wave source parameters. $\\theta \\in \\{$ $m_1$ (mass of the heavier one), $m_2$ (mass of the lighter one), $\\mathcal{D}_L$ (luminosity distance), $\\iota$ (inclination-angle), $\\phi$ (phase-of-coalescence), $\\psi$ (polarization-angle), $ra$ (right-ascension), $dec$ (declination) $\\}$, $t$ (time-of-coalescence).\n",
    "    * $R_o^U(z_s)$: Normalized merger-rate distribution (source-frame).\n",
    "\n",
    "* Lensing related:\n",
    "    * $\\text{SL}$: Strong lensing condition.\n",
    "    * $z_L$: Redshift of the galaxy lens.\n",
    "    * $R_o^L(z_s)$: Merger rate distribution with optical depth applied for lensed events.\n",
    "    * $\\mathcal{O}$: Detectability condition, determining whether an event is observable based on specific criteria.\n",
    "    * $\\theta_L$: Parameters characterizing the lens galaxy. $\\theta_L \\in \\{$ $\\sigma$ (velocity-dispersion), $q$ (axis-ratio), $\\psi$ (axis-rotation), $\\gamma$ (mass density spectral-index), $[\\gamma_1,\\gamma_2]$ (external-shear), $[e_1,e_2]$ (ellipticity), $\\beta$ (source position) $\\}$\n",
    "    * $\\beta$: Position of the source in the source plane, relative to the lens.\n",
    "    * $\\mu_i$: Magnifications of the lensed images.\n",
    "    * $\\Delta t_i$: Time delays between the lensed images.\n",
    "\n",
    "* Others:\n",
    "    * $\\mathcal{N}^L$: Normalizing factor.\n",
    "    * $P$: Prior distribution.\n",
    "    * $\\rho(z_s,\\theta,\\mu_i,\\Delta t_i)$: Network optimal SNR of $i^{th}$ lensed image.\n",
    "    * $\\rho_{th}$: SNR threshold.\n",
    "\n",
    "Default cosmology: LambdaCDM(H0=70, Om0=0.3, Ode0=0.7). But, it can be changed by the user at LeR initialization."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2315ed42",
   "metadata": {},
   "source": [
    "## Annual Rate of Detectable Lensed Gravitational Wave Events\n",
    "\n",
    "The annual rate of detectable lensed gravitational wave events, denoted by $R_L$, quantifies the expected number of lensed events observable by gravitational wave detectors within a year. This rate is given by the following equation:\n",
    "\n",
    "$$\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "\\mathcal{R}_L &= \\mathcal{N}^L \\int P(z_s| SL)\\, \\mathcal{O}_{\\text{images}}(z_s,\\theta,\\mu_i,\\Delta t_i, \\rho_{th}) \\\\\n",
    "&\\;\\; P(\\theta)\\, P(\\theta_L|z_l, z_s, SL)\\, P(z_l|z_s, SL)\\, P(\\beta|z_s,z_l, \\theta_L, SL) dz_s d\\theta d\\theta_L dz_l d\\beta \\\\\n",
    "\\end{split} \\tag{9}\n",
    "\\end{equation}\n",
    "$$\n",
    "\n",
    "Key aspects of this equation include:\n",
    "\n",
    "* **SNR Operator,** $\\mathbf{\\mathcal{O}_{\\text{images}}(z_s,\\theta,\\mu_i,\\Delta t_i, \\rho{th})}$**:** This function determines whether the lensed GW event is detectable based on their signal-to-noise ratios (SNRs) of the images. It is a logical operator that assesses the observability of each lensed image. Refer to the next sub-section for more details.\n",
    "- **Prior Distribution,** $P(z_s| SL)$, $P(\\theta)$, $P(\\theta_L|z_l, z_s, SL)$, $P(z_l|z_s, SL)$, $P(\\beta|z_s,z_l, \\theta_L, SL)$:** These distributions represent the likelihood of the source redshift, source parameters, lens parameters, lens redshift, and source position, respectively. They are essential for characterizing the population of detectable lensed events.\n",
    "\n",
    "The calculation of $R_L$ involves integration over the source redshift $z_s$, the GW source parameters $\\theta$, the lens parameters $\\theta_L$ and lens redshift $z_l$, and the source position $\\beta$. This integration accounts for the contributions from all detectable lensed events across different redshifts and parameter configurations, providing a comprehensive estimate of the annual rate of detectable lensed GW events."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8e3b601e",
   "metadata": {},
   "source": [
    "## SNR Operator for Lensed Gravitational Wave Events\n",
    "\n",
    "The SNR operator, denoted as $\\mathcal{O}$, is used to determine the detectability of lensed gravitational wave (GW) events based on their signal-to-noise ratios (SNRs). By default, the operator is configured to assess the detectability of events with two lensed images, although this can be adjusted to accommodate events with three or four images. A lensed GW event is considered detectable if at least two of its images have SNRs that exceed a predefined threshold ($\\rho_{th}$), referred to as two super-threshold events.\n",
    "\n",
    "SNR operator over all images is defined as follows:\n",
    "\n",
    "$$\\mathcal{O}_{images}(z_s,\\theta,\\mu_i,\\Delta t_i, \\rho_{th}) = \\left\\{ \n",
    "  \\begin{array}{ c l }\n",
    "    1 & \\sum_i^{images} \\Theta[\\rho(z_s,\\theta,\\mu_i,\\Delta t_i)-\\rho_{th}]\\ge 2 \\\\\n",
    "    0 & \\text{otherwise}\n",
    "  \\end{array}\n",
    "\\right.$$\n",
    "\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "\\end{split}\\tag{4}\n",
    "\\end{equation}\n",
    "\n",
    "In this definition:\n",
    "* $\\Theta$ represents the Heaviside step function, which evaluates to 1 if its argument is greater than or equal to zero, and 0 otherwise.\n",
    "* $\\rho(z_s,\\theta,\\mu_i,\\Delta t_i)$ is the SNR of the $i_{\\text{th}}$ image. When a GW signal is lensed, it splits into multiple images, each with altered properties. The effective luminosity distance for the $i_{\\text{th}}$ image is given by $\\mathcal{D}_{L,i}^{eff} = \\mathcal{D}_L / \\sqrt{|\\mu_i|}$, where $\\mathcal{D}_L$ is the original luminosity distance and $\\mu_i$ is the magnification of the image. Similarly, the effective geocentric time for the $i_{\\text{th}}$ image is $t_i^{eff} = t + \\Delta t_i$, where $t$ is the original time of arrival and $\\Delta t_i$ is the time delay of the image.\n",
    "\n",
    "This SNR operator plays a crucial role in the analysis of lensed GW events, as it helps to identify events that are sufficiently strong to be detected by GW observatories."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8103cf02",
   "metadata": {},
   "source": [
    "## Redshift distribution of lensed GW compact binary coalescences (CBC)\n",
    "\n",
    "This is very similar to the un-lensed events redshift distribution $P(z_s)$, but with the optical depth applied for lensed events. Optical depth ($\\tau(z-s)=P(\\text{SL}|z_s)$) is the probability that a source at redshift $z_s$ is strongly lensed by a galaxy. The lensed redshift distribution is given by:\n",
    "\n",
    "$$\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "P(z_s|SL) = \\frac{R(z_s)}{\\mathcal{N}^L} P(SL|z_s) \\frac{1}{(1+z_s)} \\frac{dV_c}{dz_s} \\nonumber\n",
    "\\end{split} \n",
    "\\end{equation}\n",
    "$$\n",
    "\n",
    "R(z_s) is the merger rate distribution of CBC in the source frame.\n",
    "\n",
    "The normalizing factor is given by:\n",
    "\n",
    "$$\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "\\mathcal{N}^L = \\int_{z_{min}}^{z_{max}} R(z_s) P(SL|z_s) \\frac{1}{(1+z_s)} \\frac{dV_c}{dz_s} dz_s \\nonumber\n",
    "\\end{split}\n",
    "\\end{equation}\n",
    "$$\n",
    "\n",
    "Source redshifts for lensed case are sample from an astrophysical distribution, and rejection sample based on the optical depth. The plot below shows the comparision of the lensed and un-lensed merger rate distributions.\n",
    "\n",
    "<p align=\"center\">\n",
    "  <img src=\"_static/zs_vs.png\" alt=\"zs\" width=\"80%\">\n",
    "</p>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bb853686",
   "metadata": {},
   "source": [
    "## Sampling Lens Properties\n",
    "\n",
    "In `LeR`, we consider elliptical galaxy lenses with a power-law mass-density distribution and external shear, also refer to as **EPL+Shear** lens. The sampling methods for the lens parameters are summarized in the following tables. Note that $D_l^c$ and $D_s^c$ are the comoving distances to the lens and source, respectively.\n",
    "\n",
    "**Table I: Lens Redshift and Physical Parameters**\n",
    "\n",
    "| Parameter | unit | sampling method | range |\n",
    "| :- | :- | :- | :- |\n",
    "| $z_l$: Lens redshift | None | (i) $r$ from $P(x)=30x^2(1-x)^2$<br> (ii) Sacling: $D_l^c=r D_s^c$<br> (iii) $D_l^c\\rightarrow z_l$ with default cosmology | [0,$z_s$] |\n",
    "| $\\sigma$: velocity dispersion | km s^-1 | $\\pi(\\sigma_l, z_l)=\\phi(\\sigma_l, z_l)\\frac{dV(z_l)}{dz_l}$<br> refer to [Wempe et al. 2022](https://arxiv.org/pdf/2204.08732.pdf) | [0,600] |\n",
    "| $q$: axis-ratio | None | (i) $b$ from Rayleigh distribution,<br> $P(b)=\\frac{b}{s^2} \\exp(-\\frac{b^2}{2s^2})$<br> where $s=0.38-0.09177a$ and<br> $a=\\sigma/161$<br> (ii) $q=1-b$ | [0.2,1] |\n",
    "\n",
    "The cross-section ($\\mathcal{S}$) of a SIE lens, along with the Einstein radius ($\\theta_E$), is calculated using the following equations. $\\mathcal{S}$ determines the probability of a source being lensed by a galaxy, and $\\theta_E$ is defined as the angular radius of the ring-like image (known as the Einstein ring) formed when a distant light source, a lensing galaxy, and an observer are perfectly aligned. In the equation, $D_{Ls}$ and $D_s$ are the angular diameter distances from the lens to the source and from the observer to the source, respectively, $c$ is the speed of light. $\\phi^{SIE}_{CUT}(q)$ is derived from the expression given in [Fei Xu et al. 2022](https://iopscience.iop.org/article/10.3847/1538-4357/ac58f8).\n",
    "\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "\\mathcal{S}(\\theta_E) &= \\pi \\theta_E^2 \\frac{\\phi^{SIE}_{CUT}(q)}{\\pi}  \\\\\n",
    "\\theta_E &= \\frac{4\\pi \\sigma^2}{c^2}\\frac{D_{Ls}}{D_s} \n",
    "\\end{split}\\tag{5}\n",
    "\\end{equation}\n",
    "\n",
    "Lens parameters in Table I are rejection sampled based on the strong lensing condition. A value is sampled from Uniform[0, max($\\mathcal{S}$)] and is selected if it is less than $\\mathcal{S}$."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6fef4acf",
   "metadata": {},
   "source": [
    "**Table II: Orientation, density and Shear Parameters**\n",
    "\n",
    "| Parameter | unit | sampling method | range |\n",
    "| :- | :- | :- | :- |\n",
    "| $\\phi$: axis-rotation-angle  | radian | Uniform | [0,2 $\\pi$] |\n",
    "| $\\gamma$: mass density spectral-index | None | Normal dist.<br>with mean=2, std=0.2 | None |\n",
    "| $[\\gamma_1,\\gamma_2]$: external-shear | None | Normal dist.<br>with mean=0, std=0.05 | None |\n",
    "\n",
    "The orientation angle ($\\phi$) and axis ratio ($q$) are transformed into complex ellipticity moduli $e_1$ and $e_2$ as follows:\n",
    "\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "e_1 &= \\frac{1-q}{1+q} \\cos(2\\phi) \\\\\n",
    "e_2 &= \\frac{1-q}{1+q} \\sin(2\\phi)\n",
    "\\end{split}\\tag{6}\n",
    "\\end{equation}\n",
    "\n",
    "Distribution of the lens parameters are shown in the following plots.\n",
    "\n",
    "<p align=\"center\">\n",
    "  <img src=\"_static/lens_params.png\" alt=\"zs params\" width=\"100%\">\n",
    "</p>\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9040762d",
   "metadata": {},
   "source": [
    "## Sampling of Source Position\n",
    "\n",
    "The source position ($\\beta$) is sampled uniformly from within and around the caustic region in the source plane. This region, which refer I will refer to as `caustic double`, is defined by the boundary within which a point source generates multiple images (two or more). The shape and size of this boundary depend on the lens parameters and the redshift of the source. The area in the source plane that results in the formation of multiple images is accurately determined using the Lenstronomy software.\n",
    "\n",
    "The animated figure below demonstrates how the source position and the resulting image positions vary within and around the caustic region, showcasing the process of multiple image formation by a elliptical lens. The megenta point indicates the varying position of the source within the source plane, and the orange points are the corresponding lensed image positions. The green line delineates the caustic boundary, the red line signify critical lines at the image plane, and blue shaded area is the `caustic double` region. As the source drifts closer to a caustic line and beyond, the observed number of multiple images correspondingly decreases, illustrating the dynamic nature of gravitational lensing.\n",
    "\n",
    "<p align=\"center\">\n",
    "  <img src=\"_static/moving_source.gif\" alt=\"source position\" width=\"80%\">\n",
    "</p>\n",
    "\n",
    "Souce position in lens plane : $\\beta = [x,y] = [\\eta\\,cos(\\phi),\\eta\\,sin(\\phi)]$. Sampling methods is given in the following table.\n",
    "\n",
    "**Table III: Source Position Parameters**\n",
    "\n",
    "|Parameter | unit | sampling method |\n",
    "| :-: | :-: | :-: |\n",
    "| $x$  | $\\theta_E$ | within the double caustic |\n",
    "| $y$  | $\\theta_E$  | within the double caustic |"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d94a3b59",
   "metadata": {},
   "source": [
    "## Calculation of Images properties\n",
    "\n",
    "The properties of the lensed images, such as the lens positions ($x_0, x_1$), magnifications ($\\mu_i$), time delays ($\\Delta t_i$) and morse phase ($n_i$), are calculated using the lens and source parameters. This is achieved through `lenstronomy`'s lens equation solver. As of 19/03/2024, only EPL+Shear solver is available. For, SIE model solutions set $\\gamma=2$, $\\phi=0$, $[\\gamma_1,\\gamma_2]=[0,0]$, and $[e_1,e_2]=[0,0]$. NFW profile will be added in the future.\n",
    "\n",
    "**Note:** Source postion $[x,y]$ and image positions $[x_0,x_1]$ are wrt to the center of the lens galaxy (thin lens approximation). But in the sky map the source position will be defined by the sampled $[ra,dec]$.\n",
    "\n",
    "Below is the plot for the distribution of time delays difference between the lensed images. $\\Delta n=0\\deg$ correspond to either [type-I, type-I] or [type-II, type-II] lensed images. $\\Delta n=90\\deg$ correspond to [type-I, type-II] lensed images. Time delays difference between uncorrelated un-lensed events follows a poisson distribution.\n",
    "\n",
    "<p align=\"center\">\n",
    "  <img src=\"_static/timedelays.png\" alt=\"zs\">\n",
    "</p>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "535e99d6",
   "metadata": {},
   "source": [
    "## Statistical Form of Detectable Merger Rate of lensed events (Monte Carlo Integration)\n",
    "\n",
    "The detectable merger rate of lensed events, $R_L$, can be statistically estimated using Monte Carlo integration. This can be done using either a step function or the probability of detection ($P_{\\text{det}}$).\n",
    "\n",
    "- **With Step Function:**\n",
    "\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "R_L &= \\mathcal{N}^U \\left< \\mathcal{O}_{images}(z_s,\\theta,\\mu_i,\\Delta t_i, \\rho_{th})\\,\\right>_{z_s,z_L,\\theta,\\theta_L \\in \\text{Sampled}[z_s,z_L,\\theta,\\theta_L]}  \\\\\n",
    "&= \\frac{\\mathcal{N}^U}{N} \\sum_i \\mathcal{O}_{images}(z_s,\\theta,\\mu_i,\\Delta t_i, \\rho_{th})\n",
    "\\end{split} \\tag{8}\n",
    "\\end{equation}\n",
    "\n",
    "- **With $P_{\\text{det}}$:**\n",
    "\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "R_L &= \\mathcal{N}^U \\left< \\,P_{det}^{max(\\rho)_1} \\,P_{det}^{max(\\rho)_2} \\,\\right>_{z_s,z_L,\\theta,\\theta_L \\in \\text{Sampled}[z_s,z_L,\\theta,\\theta_L]} \\\\\n",
    "&= \\frac{\\mathcal{N}^U}{N} \\sum_i \\,P_{det}^{max(\\rho)_1} \\,P_{det}^{max(\\rho)_2}\n",
    "\\end{split} \\tag{9}\n",
    "\\end{equation}\n",
    "\n",
    "In both cases, the average is taken over a sample of $(z_s, z_L, \\theta, \\theta_L)$, where $N$ is the total number of samples. The SNR operator $\\mathcal{O}_{images}(z_s,\\theta,\\mu_i,\\Delta t_i, \\rho_{th})$ evaluates to 1 if two of the images of the lensed GW event are detectable, and 0 otherwise. The probability of detection, $P_{\\text{det}}$, provides a smoother transition from detectable to non-detectable events at the SNR threshold.\n",
    "\n",
    "The table below presents the merger rate values for two different detector configurations, considering spin-less systems for simplicity. The signal-to-noise ratio (SNR) operator is implemented using a step function with a threshold of 8, and the waveform approximant used is IMRPhenomD.\n",
    "\n",
    "| Detector Configuration | BBH (un-lensed) Merger Rate (yr<sup>-1</sup>) | BBH (lensed) Merger Rate (yr<sup>-1</sup>) | Ratio |\n",
    "|-------------------|---------|-------|--------|\n",
    "| [L1, H1, V1] (O4) | 440.9   | 1.1   | ~400:1 |\n",
    "| [A+, CE, ET] (3G) | 91843.6 | 152.4 | ~600:1 |     "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3235c0d2",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "ler",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.14"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
